<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd">

<mapper namespace="com.dkitec.barocle.admin.maintenance.inspect.station.service.InspectStationMapper">
	
	<select id="getInspectStationList" parameterType="InspectStationVO" resultType="InspectStationVO">
		SELECT FSTA.STATION_ID AS stationId
			,FSTA.STATION_NAME AS stationNm
			,FSTA.BIKE_COUNT AS bikeCnt
			,FSTA.FAULT_COUNT AS falutCnt
			,FSTA.STATION_USE_YN AS stationUseYn
		FROM (
			SELECT DISTINCT(STATION_ID)
			,STATION_NAME
			,COUNT(*) AS BIKE_COUNT
			,SUM(CASE WHEN FAULT.TOT_MOVE_DIST > 0 THEN 1 ELSE 0 END ) AS FAULT_COUNT
			,FAULT.USE_CNT
			,TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(STATION_NAME, '.', 1 + 1), '.', -1)) AS ORDER_STATION_NAME
			,STATION_USE_YN
			FROM (
				SELECT STA.STATION_ID,RACK.NOW_STATION_EQUIP_ORD,RACK.RACK_ID,BIKE.BIKE_ID,BIKE.CASCADE_YN,STATION_NAME, STA.STATION_USE_YN
				FROM TB_OPR_STATION  STA, TB_OPR_RACK RACK, TB_OPR_BIKE_PARKING BIKE , TB_OPR_MLANG_STATION MSTA
				WHERE STA.STATION_ID = RACK.NOW_LOCATE_ID
				AND RACK.RACK_ID = BIKE.RACK_ID
				AND STA.STATION_ID = MSTA.STATION_ID
				AND MSTA.LANG_CLS_CD='LAG_001'
				AND STA.STATION_ID NOT IN ('ST-74', 'ST-982', 'ST-48', 'ST-380', 'ST-618', 'ST-484')
			) DEF_BIKE
			LEFT JOIN TB_OPR_BIKE FAULT
			ON FAULT.BIKE_ID = DEF_BIKE.BIKE_ID
			AND FAULT.BIKE_STUS_CD = 'BKS_001'
			GROUP BY STATION_ID
			) FSTA
		WHERE 1=1
		AND FSTA.BIKE_COUNT = FSTA.FAULT_COUNT
		ORDER BY FSTA.ORDER_STATION_NAME
		<if test='pagingYn == "Y"'>
		<![CDATA[
		LIMIT #{firstRecordIndex}, #{recordCountPerPage}
		]]>
		</if> 
	</select>
	
	<select id="getInspectStationListCount" parameterType="InspectStationVO" resultType="int">
	SELECT COUNT(*)
	FROM (
		SELECT DISTINCT(STATION_ID)
		,STATION_NAME
		,COUNT(*) AS BIKE_COUNT
		,SUM(CASE WHEN FAULT.TOT_MOVE_DIST > 0 THEN 1 ELSE 0 END ) AS FAULT_COUNT
		,FAULT.USE_CNT
		,TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(STATION_NAME, '.', 1 + 1), '.', -1)) AS ORDER_STATION_NAME
		,STATION_USE_YN
		FROM (
			SELECT STA.STATION_ID,RACK.NOW_STATION_EQUIP_ORD,RACK.RACK_ID,BIKE.BIKE_ID,BIKE.CASCADE_YN,STATION_NAME, STA.STATION_USE_YN
			FROM TB_OPR_STATION  STA, TB_OPR_RACK RACK, TB_OPR_BIKE_PARKING BIKE , TB_OPR_MLANG_STATION MSTA
			WHERE STA.STATION_ID = RACK.NOW_LOCATE_ID
			AND RACK.RACK_ID = BIKE.RACK_ID
			AND STA.STATION_ID = MSTA.STATION_ID
			AND MSTA.LANG_CLS_CD='LAG_001'
			AND STA.STATION_ID NOT IN ('ST-74', 'ST-982', 'ST-48', 'ST-380', 'ST-618', 'ST-484')
		) DEF_BIKE
		LEFT JOIN TB_OPR_BIKE FAULT
		ON FAULT.BIKE_ID = DEF_BIKE.BIKE_ID
		AND FAULT.BIKE_STUS_CD = 'BKS_001'
		GROUP BY STATION_ID
		) FSTA
	WHERE 1=1
	AND FSTA.BIKE_COUNT = FSTA.FAULT_COUNT
	ORDER BY FSTA.ORDER_STATION_NAME
	</select>
	
</mapper>
